<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <base href="/"></base>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title> :: Reasonably Polymorphic</title>
        <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
        <link href="/atom.xml" rel="alternate" title="Reasonably Polymorphic - Atom" type="application/atom+xml" />
        <link href="/feed.rss" rel="alternate" title="Reasonably Polymorphic - RSS" type="application/rss+xml" />

        <link rel="stylesheet" href="/css/style.css" />
        <link rel="stylesheet" href="/css/katex.min.css" />
        <link rel="stylesheet" href="/css/agda-cats.css" />

        <script src="/equations.js"></script>
        <script src="/highlight-hover.js"></script>

  <noscript>
    <style>
      body span.reasoning-step .as-written {
        display: inline;
      }

      body span.reasoning-step .alternate {
        display: none;
      }
    </style>
  </noscript>

        </head>
        <body>
<div class="main">

<article>
<header>
  <h1><a href="/polysemy-talk/index.html#"></a></h1>
</header>
<p class="meta">
    <time></time>

    <span class="tags">
        
    </span>
</p>
<div class="content">
    <h1 id="polysemy"><a href="#polysemy" class="header-link">Polysemy<span class="header-link-emoji">🔗</span></a></h1>
<h2 id="chasing-performance-in-free-monads"><a href="#chasing-performance-in-free-monads" class="header-link">Chasing Performance in Free Monads<span class="header-link-emoji">🔗</span></a></h2>
<hr />
<ul>
<li><p><strong>Sandy Maguire</strong></p></li>
<li><p>sandy@sandymaguire.me</p></li>
<li><p>reasonablypolymorphic.com</p></li>
<li><p>github.com/isovector</p></li>
</ul>
<p>Today’s slides:</p>
<ul>
<li>reasonablypolymorphic.com/polysemy-talk</li>
</ul>
<hr />
<p>Our codebase was written by contractors.</p>
<p>Big ball o’ IO spaghetti.</p>
<p>Impossible to test.</p>
<hr />
<p><em>Free monads</em> are what I think programming will look like in 30 years.</p>
<div class="incremental">
<p>Write your applications in <em>domain specific language</em> designed for your exact problem.</p>
</div>
<div class="incremental">
<p><em>Run a series of transformations</em> to compile your high-level specification into lower-level DSLs.</p>
<hr />
<p>Most programs are easy to describe.</p>
</div>
<div class="incremental">
<p>The majority of a codebase is spent dealing with nitty-gritty details.</p>
</div>
<div class="incremental">
<p>This is where most of the bugs are.</p>
<hr />
<p>Let’s turn implementation details into library code!</p>
<hr />
</div>
<h1 id="example"><a href="#example" class="header-link">Example<span class="header-link-emoji">🔗</span></a></h1>
<p>Data ingestion service that:</p>
<ul>
<li>reads encrypted CSV files</li>
<li>emits them in batches to a streaming HTTP service</li>
<li>records statistics in Redis</li>
</ul>
<hr />
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>ingest</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> ( <span class="dt">Member</span> (<span class="dt">Input</span> <span class="dt">Record</span>) r</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>       , <span class="dt">Member</span> (<span class="dt">Output</span> <span class="dt">Record</span>) r</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>       , <span class="dt">Member</span> (<span class="dt">Output</span> <span class="dt">Stat</span>) r</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>       )</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> <span class="dt">Eff</span> r ()</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>ingest <span class="ot">=</span> input <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Nothing</span>     <span class="ot">-&gt;</span> <span class="fu">pure</span> ()</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Just</span> record <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    output record</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    output <span class="dt">ProcessedRecordStat</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    ingest</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ Input Record, Output Record, Output Stat }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></span></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FileProvider, Output Record, Output Stat }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> decryptFileProvider</span></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FileProvider, Output Record, Output Stat, Encryption }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> decryptFileProvider</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> ftpFileProvider</span></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FTP, Output Record, Output Stat, Encryption }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> decryptFileProvider</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> ftpFileProvider</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> batch      <span class="op">@</span><span class="dt">Record</span> <span class="dv">500</span></span></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FTP, Output [Record], Output Stat, Encryption }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> decryptFileProvider</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> ftpFileProvider</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> batch      <span class="op">@</span><span class="dt">Record</span> <span class="dv">500</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> postOutput <span class="op">@</span><span class="dt">Record</span> mkApiCall</span></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FTP, HTTP, Output Stat, Encryption }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> decryptFileProvider</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> ftpFileProvider</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> batch      <span class="op">@</span><span class="dt">Record</span> <span class="dv">500</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> postOutput <span class="op">@</span><span class="dt">Record</span> mkApiCall</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> redisOuput <span class="op">@</span><span class="dt">Stat</span>   mkRedisKey</span></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{FTP, HTTP, Encryption, Redis}</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> decryptFileProvider</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> ftpFileProvider</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> batch      <span class="op">@</span><span class="dt">Record</span> <span class="dv">500</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> postOutput <span class="op">@</span><span class="dt">Record</span> mkApiCall</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> redisOuput <span class="op">@</span><span class="dt">Stat</span>   mkRedisKey</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runEncryption</span></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FTP, HTTP, Redis}</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> decryptFileProvider</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> ftpFileProvider</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> batch      <span class="op">@</span><span class="dt">Record</span> <span class="dv">500</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> postOutput <span class="op">@</span><span class="dt">Record</span> mkApiCall</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> redisOuput <span class="op">@</span><span class="dt">Stat</span>   mkRedisKey</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runEncryption</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runHTTP</span></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FTP, Redis }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> decryptFileProvider</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> ftpFileProvider</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> batch      <span class="op">@</span><span class="dt">Record</span> <span class="dv">500</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> postOutput <span class="op">@</span><span class="dt">Record</span> mkApiCall</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> redisOuput <span class="op">@</span><span class="dt">Stat</span>   mkRedisKey</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runEncryption</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runHTTP</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runFTP</span></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ Redis }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> decryptFileProvider</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> ftpFileProvider</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> batch      <span class="op">@</span><span class="dt">Record</span> <span class="dv">500</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> postOutput <span class="op">@</span><span class="dt">Record</span> mkApiCall</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> redisOuput <span class="op">@</span><span class="dt">Stat</span>   mkRedisKey</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runEncryption</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runHTTP</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runFTP</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runRedis</span></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> ingest</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> decryptFileProvider</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> ftpFileProvider</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> batch      <span class="op">@</span><span class="dt">Record</span> <span class="dv">500</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> postOutput <span class="op">@</span><span class="dt">Record</span> mkApiCall</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> redisOuput <span class="op">@</span><span class="dt">Stat</span>   mkRedisKey</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runEncryption</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runHTTP</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runFTP</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runRedis</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runM</span></code></pre></div>
<hr />
<p>But maybe we want to test this without a million mocked services?</p>
<div class="incremental">
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ot">test ::</span> ([<span class="dt">Stat</span>], ([<span class="dt">Record</span>], ()))</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> ingest</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runInput [record1, record2]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runPureOuput <span class="op">@</span><span class="dt">Recor</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> runPureOuput <span class="op">@</span><span class="dt">Stat</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> run</span></code></pre></div>
<hr />
<p>If both a test and real interpreter are correct,</p>
</div>
<div class="incremental">
<p>And the program is correct under the test,</p>
</div>
<div class="incremental">
<p>Then the program is correct under the real interpreter!</p>
</div>
<div class="incremental">
<p><strong>Correctness composes!</strong></p>
<hr />
<p>Two major players in the free monad space:</p>
</div>
<div class="incremental">
<h2 id="freer-simple"><a href="#freer-simple" class="header-link">freer-simple<span class="header-link-emoji">🔗</span></a></h2>
<ul>
<li>No boilerplate!</li>
<li>Friendly to use!</li>
<li>35x slower than theoretically possible.</li>
<li>Incapable of expressing lots of desirable effects.</li>
</ul>
<h2 id="fused-effects"><a href="#fused-effects" class="header-link">fused-effects<span class="header-link-emoji">🔗</span></a></h2>
<ul>
<li>SO MUCH BOILERPLATE.</li>
<li>Not very friendly.</li>
<li>As fast as possible!</li>
<li>All effects are expressible!</li>
</ul>
<div class="incremental">
<p><strong>Neither of these is a good trade-off!</strong></p>
<hr />
<p>My new library:</p>
</div>
<h2 id="polysemy-1"><a href="#polysemy-1" class="header-link">polysemy<span class="header-link-emoji">🔗</span></a></h2>
<ul>
<li>No boilerplate!</li>
<li>Friendly to use!</li>
<li>As fast as possible!</li>
<li>All effects are expressible!</li>
</ul>
<div class="incremental">
<p><em>The best of both worlds!</em></p>
<hr />
<p>We’ll discuss how this was possible!</p>
</div>
<div class="incremental">
<p>But first, let’s get you up to speed on naive free monads.</p>
<hr />
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Teletype</span> k</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Done</span> k</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">WriteLine</span> <span class="dt">String</span> (<span class="dt">Teletype</span> k)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Teletype</span> k)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="ot">echo ::</span> <span class="dt">Teletype</span> ()</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>echo <span class="ot">=</span> <span class="dt">ReadLine</span> <span class="op">$</span> \msg <span class="ot">-&gt;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>       <span class="dt">WriteLine</span> msg</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>     <span class="op">$</span> <span class="dt">Done</span> ()</span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> <span class="dt">Teletype</span> <span class="kw">where</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="ot">=</span> <span class="dt">Done</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Done</span>          k <span class="op">&gt;&gt;=</span> f <span class="ot">=</span> f k</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">WriteLine</span> msg k <span class="op">&gt;&gt;=</span> f <span class="ot">=</span> <span class="dt">WriteLine</span> msg <span class="op">$</span> k <span class="op">&gt;&gt;=</span> f</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ReadLine</span>      k <span class="op">&gt;&gt;=</span> f <span class="ot">=</span> <span class="dt">ReadLine</span> <span class="op">$</span> \str <span class="ot">-&gt;</span> k str <span class="op">&gt;&gt;=</span> f</span></code></pre></div>
<hr />
<p>Because it’s a monad, we can write this more idiomatically.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echo ::</span> <span class="dt">Teletype</span> ()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>echo <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> <span class="dt">ReadLine</span> <span class="dt">Done</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">WriteLine</span> msg <span class="op">$</span> <span class="dt">Done</span> ()</span></code></pre></div>
<hr />
<p>… and define evaluation semantics for it.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ot">runTeletypeInIO ::</span> <span class="dt">Teletype</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>runTeletypeInIO (<span class="dt">Done</span> a) <span class="ot">=</span> <span class="fu">pure</span> a</span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>runTeletypeInIO (<span class="dt">WriteLine</span> msg k) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> msg</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  runTeletypeInIO k</span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>runTeletypeInIO (<span class="dt">ReadLine</span> k) <span class="ot">=</span>  <span class="kw">do</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> <span class="fu">getLine</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  runTeletypeInIO <span class="op">$</span> k msg</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ot">runTeletypePurely ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">Teletype</span> a <span class="ot">-&gt;</span> ([<span class="dt">String</span>], a)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>runTeletypePurely _ (<span class="dt">Done</span> a) <span class="ot">=</span> ([], a)</span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>runTeletypePurely ls (<span class="dt">WriteLine</span> msg k) <span class="ot">=</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> (rs, a) <span class="ot">=</span> runTeletypePurely ls k</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">in</span> (msg <span class="op">:</span> rs, a)</span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>runTeletypePurely []       (<span class="dt">ReadLine</span> k) <span class="ot">=</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  runTeletypePurely [] <span class="op">$</span> k <span class="st">&quot;&quot;</span></span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>runTeletypePurely (l <span class="op">:</span> ls) (<span class="dt">ReadLine</span> k) <span class="ot">=</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  runTeletypePurely ls <span class="op">$</span> k l</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Teletype</span> k</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Done</span> k</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">WriteLine</span> <span class="dt">String</span> (<span class="dt">Teletype</span> k)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Teletype</span> k)</span></code></pre></div>
<p>The <code>Done</code> constructor and the recursion are only necessary to make this a <code>Monad</code>.</p>
<p>We can factor them out.</p>
<hr />
<p>Before:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Teletype</span> k</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Done</span> k</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">WriteLine</span> <span class="dt">String</span> (<span class="dt">Teletype</span> k)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Teletype</span> k)</span></code></pre></div>
<p>After:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Free</span> f k</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Pure</span> k</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Impure</span> (f (<span class="dt">Free</span> f k))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Teletype</span> a</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">WriteLine</span> <span class="dt">String</span> a</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> a)</span></code></pre></div>
<hr />
<p><code>Free f</code> is a <code>Monad</code> whenever <code>f</code> is a <code>Functor</code>!</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Functor</span> f <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">Free</span> f) <span class="kw">where</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="ot">=</span> <span class="dt">Pure</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Pure</span> k   <span class="op">&gt;&gt;=</span> f <span class="ot">=</span> f k</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Impure</span> z <span class="op">&gt;&gt;=</span> f <span class="ot">=</span> <span class="dt">Impure</span> <span class="op">$</span> <span class="fu">fmap</span> (\x <span class="ot">-&gt;</span> x <span class="op">&gt;&gt;=</span> f) z</span></code></pre></div>
<hr />
<p>Let’s write some helper functions:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ot">writeLine ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> <span class="dt">Teletype</span> ()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>writeLine msg <span class="ot">=</span> <span class="dt">Impure</span> <span class="op">$</span> <span class="dt">WriteLine</span> msg <span class="op">$</span> <span class="fu">pure</span> ()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="ot">readLine ::</span> <span class="dt">Free</span> <span class="dt">Teletype</span> <span class="dt">String</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>readLine <span class="ot">=</span> <span class="dt">Impure</span> <span class="op">$</span> <span class="dt">ReadLine</span> <span class="fu">pure</span></span></code></pre></div>
</div>
<div class="incremental">
<p><code>echo</code> is no longer conspicuous:</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echo ::</span> <span class="dt">Free</span> <span class="dt">Teletype</span> ()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>echo <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> readLine</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  writeLine msg</span></code></pre></div>
<hr />
<p>We can also factor out the evaluation plumbing:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>runFree</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">Monad</span> m</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> (∀ x<span class="op">.</span> f x <span class="ot">-&gt;</span> m x)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Free</span> f a</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> m a</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>runFree _ (<span class="dt">Pure</span> a)  <span class="ot">=</span> <span class="fu">pure</span> a</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>runFree f (<span class="dt">Impure</span> k) <span class="ot">=</span> f k <span class="op">&gt;&gt;=</span> runFree f</span></code></pre></div>
</div>
<div class="incremental">
<p>Less boilerplate in our interpretation:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ot">runTeletypeInIO ::</span> <span class="dt">Free</span> <span class="dt">Teletype</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>runTeletypeInIO <span class="ot">=</span> runFree <span class="op">$</span> \<span class="kw">case</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">WriteLine</span> msg k <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">putStrLn</span> msg</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> k</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ReadLine</span> k <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    msg <span class="ot">&lt;-</span> <span class="fu">getLine</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="op">$</span> k msg</span></code></pre></div>
<hr />
</div>
</div>
<h1 id="combining-multiple-effects"><a href="#combining-multiple-effects" class="header-link">Combining Multiple Effects<span class="header-link-emoji">🔗</span></a></h1>
<div class="sourceCode" id="cb33"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Bell</span> k</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">RingBell</span> k</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> <span class="dt">Functor</span></span></code></pre></div>
<div class="incremental">
<div class="sourceCode" id="cb34"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Sum</span> f g a</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">L</span> (f a)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">R</span> (g a)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Functor</span> f, <span class="dt">Functor</span> g) <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">Sum</span> f g)</span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb35"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">TeletypeWithBell</span> <span class="ot">=</span> <span class="dt">Sum</span> <span class="dt">Teletype</span> <span class="dt">Bell</span></span></code></pre></div>
<hr />
<p>Before:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ot">writeLine ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> <span class="dt">Teletype</span> ()</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>writeLine msg <span class="ot">=</span> <span class="dt">Impure</span> <span class="op">$</span> <span class="dt">WriteLine</span> msg <span class="op">$</span> <span class="fu">pure</span> ()</span></code></pre></div>
<p>After:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ot">writeLine ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> <span class="dt">TeletypeWithBell</span> ()</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>writeLine msg <span class="ot">=</span> <span class="dt">Impure</span> <span class="op">$</span> <span class="dt">L</span> <span class="op">$</span> <span class="dt">WriteLine</span> msg <span class="op">$</span> <span class="fu">pure</span> ()</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="ot">ringBell ::</span> <span class="dt">Free</span> <span class="dt">TeletypeWithBell</span> ()</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>ringBell <span class="ot">=</span> <span class="dt">Impure</span> <span class="op">$</span> <span class="dt">R</span> <span class="op">$</span> <span class="dt">RingBell</span> <span class="op">$</span> <span class="fu">pure</span> ()</span></code></pre></div>
<hr />
<p>We can interleave actions from both effects.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ot">ringItSingIt ::</span> <span class="dt">Free</span> <span class="dt">TeletypeWithBell</span> ()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>ringItSingIt <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> readLine</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  when (msg <span class="op">==</span> <span class="st">&quot;ring the bell!&quot;</span>) ringBell</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb39"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>interpret</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">Monad</span> m</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> (<span class="kw">forall</span> x<span class="op">.</span> f x <span class="ot">-&gt;</span> m x)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> (<span class="kw">forall</span> x<span class="op">.</span> g x <span class="ot">-&gt;</span> m x)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Sum</span> f g a</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> m a</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>interpret hf _ (<span class="dt">L</span> mf) <span class="ot">=</span> hf mf</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>interpret _ hg (<span class="dt">R</span> mg) <span class="ot">=</span> hg mg</span></code></pre></div>
</div>
<div class="incremental">
<p>We can nest effects as deeply as we want inside of <code>Sum</code>!</p>
<hr />
</div>
<h1 id="effects-a-la-carte"><a href="#effects-a-la-carte" class="header-link">Effects a la Carte<span class="header-link-emoji">🔗</span></a></h1>
<div class="sourceCode" id="cb40"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Union</span> r a</span></code></pre></div>
<div class="incremental">
<p>For example:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="dt">Union</span> &#39;[<span class="dt">Bell</span>, <span class="dt">Teletype</span>, <span class="dt">State</span> <span class="dt">Bool</span>, <span class="dt">Error</span> <span class="dt">InvalidArgument</span>] a</span></code></pre></div>
</div>
<div class="incremental">
<p><code>Union r</code> is a <code>Functor</code> iff every type inside of <code>r</code> is.</p>
<hr />
<p>We can get in and out of a <code>Union</code>.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">Member</span> f r <span class="kw">where</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  inj  ::</span> f a       <span class="ot">-&gt;</span> <span class="dt">Union</span> r a</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  proj ::</span> <span class="dt">Union</span> r a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (f a)</span></code></pre></div>
<hr />
<p>Before:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ot">writeLine ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> <span class="dt">TeletypeWithBell</span> ()</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>writeLine msg <span class="ot">=</span> <span class="dt">Impure</span> <span class="op">$</span> <span class="dt">L</span> <span class="op">$</span> <span class="dt">WriteLine</span> msg <span class="op">$</span> <span class="fu">pure</span> ()</span></code></pre></div>
<p>After:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="ot">writeLine ::</span> <span class="dt">Member</span> <span class="dt">Teletype</span> r <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">Union</span> r) ()</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>writeLine msg <span class="ot">=</span> <span class="dt">Impure</span> <span class="op">$</span> inj <span class="op">$</span> <span class="dt">WriteLine</span> msg <span class="op">$</span> <span class="fu">pure</span> ()</span></code></pre></div>
</div>
<div class="incremental">
<p>Now we are <strong>polymorphic in our capabilities</strong>.</p>
<hr />
<p>This is where <code>freer-simple</code> and <code>fused-effects</code> start to differ.</p>
</div>
<div class="incremental">
<blockquote>
<p><code>freer-simple</code> diverges to get rid of the boilerplate.</p>
</blockquote>
</div>
<div class="incremental">
<blockquote>
<p><code>fused-effects</code> diverges to get more speed and expressiveness.</p>
</blockquote>
</div>
<div class="incremental">
<p>Unfortunately, it’s unclear how to merge the two differences.</p>
<hr />
</div>
<h1 id="how-does-freer-simple-eliminate-the-boilerplate"><a href="#how-does-freer-simple-eliminate-the-boilerplate" class="header-link">How Does <code>freer-simple</code> eliminate the boilerplate?<span class="header-link-emoji">🔗</span></a></h1>
<p>Insight: because we can’t embed our effects, we can just keep them in a queue.</p>
<div class="incremental">
<p>Rather than:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>echo <span class="ot">=</span> <span class="dt">ReadLine</span> <span class="op">$</span> \msg <span class="ot">-&gt;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>       <span class="dt">WriteLine</span> msg</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">$</span> <span class="dt">Done</span> ()</span></code></pre></div>
</div>
<div class="incremental">
<p>we can just write</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>echo <span class="ot">=</span> [<span class="dt">ReadLine</span>, <span class="dt">WriteLine</span>]</span></code></pre></div>
</div>
<div class="incremental">
<p>(plus a little magic to thread the output of <code>ReadLine</code> to the input of <code>WriteLine</code>)</p>
<hr />
<p>With this encoding, we no longer need to have continuations in our effects.</p>
</div>
<div class="incremental">
<p>Before:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Teletype</span> a</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">WriteLine</span> <span class="dt">String</span> a</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> a)</span></code></pre></div>
</div>
<div class="incremental">
<p>After:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Teletype</span> a <span class="kw">where</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">WriteLine</span><span class="ot"> ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Teletype</span> ()</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ReadLine</span><span class="ot">  ::</span> <span class="dt">Teletype</span> <span class="dt">String</span></span></code></pre></div>
</div>
<div class="incremental">
<blockquote>
<p>Doesn’t require <code>Functor</code> instances</p>
</blockquote>
<blockquote>
<p>Exactly parallels the types of the actions</p>
</blockquote>
<hr />
<p>This is a great change, and is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> faster than the naive encoding!</p>
</div>
<div class="incremental">
<p>Unfortunately it has extremely high constant factors, due to needing to allocate the intermediary queue of actions.</p>
<hr />
<h2 id="too-fast-too-free"><a href="#too-fast-too-free" class="header-link">Too Fast, Too Free<span class="header-link-emoji">🔗</span></a></h2>
<p>Two months ago, Li-Yao Xia:</p>
<!-- TODO(sandy): get the real quote! -->
<blockquote>
<p>I bet if you used the final encoding of <code>Freer</code>, it would be much faster.</p>
</blockquote>
<div class="sourceCode" id="cb49"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Freer</span> r a <span class="ot">=</span> <span class="dt">Freer</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  { runFreer</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="ot">        ::</span> ∀ m</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>         <span class="op">.</span> <span class="dt">Monad</span> m</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=&gt;</span> (∀ x<span class="op">.</span> <span class="dt">Union</span> r x <span class="ot">-&gt;</span> m x)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>        <span class="ot">-&gt;</span> m a</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<div class="incremental">
<p>What the heck is this thing??</p>
<hr />
<p><code>Free</code> is uniquely determined by its interpretation function:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>runFree</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">Monad</span> m</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> (∀ x<span class="op">.</span> f x <span class="ot">-&gt;</span> m x)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Free</span> f a</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> m a</span></code></pre></div>
</div>
<div class="incremental">
<p>We can reshuffle the <code>Free</code> argument first, and use this function as our definition of <code>Freer</code>.</p>
<hr />
<p>Reshuffled:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>runFree</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">Free</span> (<span class="dt">Union</span> r) a</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> ∀ m</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">.</span> <span class="dt">Monad</span> m</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> (∀ x<span class="op">.</span> <span class="dt">Union</span> r x <span class="ot">-&gt;</span> m x)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> m a</span></code></pre></div>
</div>
<div class="incremental">
<p>Put a newtype constructor around it:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Freer</span> r a <span class="ot">=</span> <span class="dt">Freer</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  { runFreer</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="ot">        ::</span> ∀ m</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>         <span class="op">.</span> <span class="dt">Monad</span> m</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=&gt;</span> (∀ x<span class="op">.</span> <span class="dt">Union</span> r x <span class="ot">-&gt;</span> m x)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        <span class="ot">-&gt;</span> m a</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<hr />
<p>It took me a few days to work through the implications of this encoding.</p>
</div>
<div class="incremental">
<p>To my surprise, it improved the constant factors of <code>freer-simple</code> by 35x.</p>
</div>
<div class="incremental">
<p>But why?</p>
<hr />
<p>Consider the humble <code>ReaderT</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">ReaderT</span> r m a <span class="ot">=</span> <span class="dt">ReaderT</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> runReaderT ::</span> r <span class="ot">-&gt;</span> m a</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p><code>ReaderT</code> lets you read a single, constant value of type <code>r</code>.</p>
</div>
<div class="incremental">
<p>It is a zero-cost abstraction.</p>
<hr />
<p>Anything look familiar?</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>runReaderT</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">Monad</span> m</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> <span class="dt">ReaderT</span> r m a</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> r</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> m a</span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb55"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>runFreer</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">Monad</span> m</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> <span class="dt">Freer</span> r a</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> (∀ x<span class="op">.</span> <span class="dt">Union</span> r x <span class="ot">-&gt;</span> m x)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> m a</span></code></pre></div>
</div>
<div class="incremental">
<p><strong><code>Freer</code> is just <code>ReaderT</code> in disguise!</strong></p>
<hr />
<p>The proof:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> (<span class="dt">Freer</span> f) <span class="kw">where</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> a <span class="ot">=</span> <span class="dt">Freer</span> <span class="op">$</span> \nt <span class="ot">-&gt;</span> <span class="fu">pure</span> a</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  m <span class="op">&gt;&gt;=</span> f  <span class="ot">=</span> <span class="dt">Freer</span> <span class="op">$</span> \nt <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> runFreer m nt</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    runFreer (f a) nt</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">ReaderT</span> r m) <span class="kw">where</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> a <span class="ot">=</span> <span class="dt">ReaderT</span> <span class="op">$</span> \r <span class="ot">-&gt;</span> <span class="fu">pure</span> a</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  m <span class="op">&gt;&gt;=</span> f  <span class="ot">=</span> <span class="dt">ReaderT</span> <span class="op">$</span> \r <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> runReaderT m r</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    runReaderT (f a) r</span></code></pre></div>
<p>Identical <code>Monad</code> instances!</p>
<hr />
<p>We can use the natural transformation to make effects zero cost.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb57"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="ot">liftFreer ::</span> <span class="dt">Member</span> f r <span class="ot">=&gt;</span> f a <span class="ot">-&gt;</span> <span class="dt">Freer</span> r a</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>liftFreer fa <span class="ot">=</span> <span class="dt">Freer</span> <span class="op">$</span> \nt <span class="ot">-&gt;</span> nt <span class="op">$</span> inj fa</span></code></pre></div>
</div>
<div class="incremental">
<p>Now:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="ot">writeLine&#39; ::</span> <span class="dt">Member</span> <span class="dt">Teletype</span> r <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Freer</span> r ()</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>writeLine&#39; msg <span class="ot">=</span> liftFreer <span class="op">$</span> <span class="dt">WriteLine</span> msg</span></code></pre></div>
<hr />
<p>What the heck is going on?</p>
<p>Now any time our free monad wants to use an action, it immediately runs it in the final monad.</p>
<hr />
</div>
</div>
<h1 id="even-freer-freer-monads"><a href="#even-freer-freer-monads" class="header-link">Even freer freer monads<span class="header-link-emoji">🔗</span></a></h1>
<div class="sourceCode" id="cb59"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echo ::</span> <span class="dt">Member</span> <span class="dt">Teletype</span> r <span class="ot">=&gt;</span> <span class="dt">Freer</span> r ()</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>echo <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> readLine</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  writeLine msg</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>echoIO <span class="ot">=</span> runFreer runTeletypeInIO echo</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb60"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>echoIO <span class="ot">=</span> runFreer runTeletypeInIO echo</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb61"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>echoIO <span class="ot">=</span> runFreer runTeletypeInIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> readLine</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  writeLine msg</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb62"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>echoIO <span class="ot">=</span> runFreer runTeletypeInIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> liftFreer <span class="dt">ReadLine</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  liftFreer <span class="op">$</span> <span class="dt">WriteLine</span> msg</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb63"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>echoIO <span class="ot">=</span> runFreer runTeletypeInIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> <span class="dt">Freer</span> <span class="op">$</span> \nt <span class="ot">-&gt;</span> nt <span class="dt">ReadLine</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Freer</span> <span class="op">$</span> \nt <span class="ot">-&gt;</span> nt <span class="op">$</span> <span class="dt">WriteLine</span> msg</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb64"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>echoIO <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> runTeletypeInIO <span class="dt">ReadLine</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  runTeletypeInIO <span class="op">$</span> <span class="dt">WriteLine</span> msg</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb65"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>echoIO <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> <span class="kw">case</span> <span class="dt">ReadLine</span> <span class="kw">of</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>           <span class="dt">ReadLine</span>    <span class="ot">-&gt;</span> <span class="fu">getLine</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>           <span class="dt">WriteLine</span> s <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> s</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> <span class="dt">WriteLine</span> msg <span class="kw">of</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ReadLine</span>    <span class="ot">-&gt;</span> <span class="fu">getLine</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">WriteLine</span> s <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> s</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb66"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>echoIO <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> <span class="kw">case</span> <span class="dt">ReadLine</span> <span class="kw">of</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>           <span class="dt">ReadLine</span>    <span class="ot">-&gt;</span> <span class="fu">getLine</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>           <span class="co">-- WriteLine s -&gt; putStrLn msg</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> <span class="dt">WriteLine</span> msg <span class="kw">of</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- ReadLine    -&gt; getLine</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">WriteLine</span> s <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> s</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb67"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>echoIO <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> <span class="kw">case</span> <span class="dt">ReadLine</span> <span class="kw">of</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>           <span class="dt">ReadLine</span> <span class="ot">-&gt;</span> <span class="fu">getLine</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> <span class="dt">WriteLine</span> msg <span class="kw">of</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">WriteLine</span> s <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> s</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb68"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>echoIO <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> <span class="fu">getLine</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> msg</span></code></pre></div>
<div class="incremental">
<p>So free!</p>
<hr />
<p>We’ve now shown how to solve the boilerplate and performance problems.</p>
</div>
<div class="incremental">
<h2 id="lets-rewind-and-look-at-the-changes-fused-effects-makes."><a href="#lets-rewind-and-look-at-the-changes-fused-effects-makes." class="header-link">Lets rewind and look at the changes <code>fused-effects</code> makes.<span class="header-link-emoji">🔗</span></a></h2>
<hr />
</div>
<h1 id="down-the-other-trouser-where-we-left-off"><a href="#down-the-other-trouser-where-we-left-off" class="header-link">Down the other trouser (where we left off)<span class="header-link-emoji">🔗</span></a></h1>
<div class="sourceCode" id="cb69"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Free</span> r k</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Pure</span> k</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Impure</span> (<span class="dt">Union</span> r (<span class="dt">Free</span> r k))</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Teletype</span> a</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">WriteLine</span> <span class="dt">String</span> a</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> a)</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> <span class="dt">Functor</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="ot">writeLine ::</span> <span class="dt">Member</span> <span class="dt">Teletype</span> r <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> r ()</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>writeLine msg <span class="ot">=</span> <span class="dt">Impure</span> <span class="op">$</span> inj <span class="op">$</span> <span class="dt">WriteLine</span> msg <span class="op">$</span> <span class="fu">pure</span> ()</span></code></pre></div>
<hr />
<p>An effect we’d like, but can’t have:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>throw</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">Member</span> (<span class="dt">Error</span> e) r</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> e</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Free</span> r a</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="fu">catch</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">Member</span> (<span class="dt">Error</span> e) r</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> <span class="dt">Free</span> r a</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> (e <span class="ot">-&gt;</span> <span class="dt">Free</span> r a)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Free</span> r a</span></code></pre></div>
<p><code>catch</code> contains an embedded <code>Free</code>.</p>
<hr />
<p>What we’d like:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Error</span> e k</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Throw</span> e</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> ∀ x<span class="op">.</span> <span class="dt">Catch</span> (<span class="op">???</span>)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>               (e <span class="ot">-&gt;</span> <span class="op">???</span>)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>               (x <span class="ot">-&gt;</span> k)</span></code></pre></div>
<hr />
<p>Maybe</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Error</span> e r k</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Throw</span> e</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> ∀ x<span class="op">.</span> <span class="dt">Catch</span> (<span class="dt">Free</span> r x)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>               (e <span class="ot">-&gt;</span> <span class="dt">Free</span> r x)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>               (x <span class="ot">-&gt;</span> k)</span></code></pre></div>
<p>?</p>
<div class="incremental">
<p>Unfortunately this type cannot be embedded inside a <code>Union</code> :(</p>
<hr />
<p>Instead:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Error</span> e m k</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Throw</span> e</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> ∀ x<span class="op">.</span> <span class="dt">Catch</span> (m x)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>               (e <span class="ot">-&gt;</span> m x)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>               (x <span class="ot">-&gt;</span> k)</span></code></pre></div>
</div>
<div class="incremental">
<p>Just force <code>m</code> to be <code>Free r</code>:</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb74"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Free</span> r a</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Pure</span> a</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Impure</span> (<span class="dt">Union</span> r (<span class="dt">Free</span> r) a)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="ot">liftFree ::</span> <span class="dt">Member</span> f r <span class="ot">=&gt;</span> f (<span class="dt">Free</span> r) (<span class="dt">Free</span> r a) <span class="ot">-&gt;</span> <span class="dt">Free</span> r a</span></code></pre></div>
<hr />
<p>Effects don’t need to use <code>m</code> if they don’t want to.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">State</span> s m k</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Get</span> (s <span class="ot">-&gt;</span> k)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Put</span> s k</span></code></pre></div>
<hr />
<h2 id="the-problem"><a href="#the-problem" class="header-link">The Problem<span class="header-link-emoji">🔗</span></a></h2>
<p>How do <code>State</code> and <code>Error</code> interact?</p>
<div class="incremental">
<p>How can we thread state changes through a <code>Catch</code> action?</p>
<hr />
</div>
<h2 id="the-solution-functors"><a href="#the-solution-functors" class="header-link">The Solution: Functors!<span class="header-link-emoji">🔗</span></a></h2>
<div class="incremental">
<p>What is a functor, really?</p>
</div>
<div class="incremental">
<p>Just a value in some sort of context.</p>
</div>
<div class="incremental">
<p>In particular, a value of <code>f ()</code> is <em>only</em> a context!</p>
<hr />
<p>We can abuse this fact, and wrap up the state of the world as some functor.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb76"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">Effect</span> e <span class="kw">where</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  weave ::</span> <span class="dt">Functor</span> tk</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=&gt;</span> tk ()</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>        <span class="ot">-&gt;</span> (∀ x<span class="op">.</span> tk (m x) <span class="ot">-&gt;</span> n (tk x))</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>        <span class="ot">-&gt;</span> e m a</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>        <span class="ot">-&gt;</span> e n (tk a)</span></code></pre></div>
</div>
<div class="incremental">
<ul>
<li><p><code>tk ()</code> is the state of the world when the effect starts</p></li>
<li><p><code>(∀ x. tk (m x) -&gt; n (tk x))</code> is a distribution law for describing how to run effects in a context.</p></li>
</ul>
</div>
<div class="incremental">
<p><code>weave</code> allows an effect to have other effects “pushed through it.”</p>
<hr />
<p>Weaving through <code>Error</code>:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Effect</span> (<span class="dt">Error</span> e) <span class="kw">where</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  weave _ _ (<span class="dt">Throw</span> e) <span class="ot">=</span> <span class="dt">Throw</span> e</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  weave tk distrib (<span class="dt">Catch</span> try handle k) <span class="ot">=</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Catch</span> (distrib <span class="op">$</span> try <span class="op">&lt;$</span> tk)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>          (\e <span class="ot">-&gt;</span> distrib <span class="op">$</span> handle e <span class="op">&lt;$</span> tk)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>          (<span class="fu">fmap</span> k)</span></code></pre></div>
</div>
<div class="incremental">
<p>The “ice-cream cone” operator replaces the contents of a <code>Functor</code>:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="ot">(&lt;$) ::</span> <span class="dt">Functor</span> f <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> f b <span class="ot">-&gt;</span> f a</span></code></pre></div>
<hr />
<p>The <code>State</code> effect needs to push its state through other effects’ subcomputations.</p>
<p>It can call <code>weave</code> to do this.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb79"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="ot">runState ::</span> s <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">State</span> s &#39;<span class="op">:</span> r) a <span class="ot">-&gt;</span> <span class="dt">Free</span> r (s, a)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>runState s (<span class="dt">Pure</span> a) <span class="ot">=</span> <span class="fu">pure</span> (s, a)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>runState s (<span class="dt">Impure</span> u) <span class="ot">=</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> decomp u <span class="kw">of</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Left</span> other <span class="ot">-&gt;</span> <span class="dt">Impure</span> <span class="op">$</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>      weave (s, ())</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>            (\(s&#39;, m) <span class="ot">-&gt;</span> runState s&#39; m)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>            other</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Right</span> (<span class="dt">Get</span> k)    <span class="ot">-&gt;</span> <span class="fu">pure</span> (s,  k s)</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Right</span> (<span class="dt">Put</span> s&#39; k) <span class="ot">-&gt;</span> <span class="fu">pure</span> (s&#39;, k)</span></code></pre></div>
</div>
<div class="incremental">
<p><code>decomp</code> can extract a single effect out of a <code>Union</code>; or prove that it was never there to begin with.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb80"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>decomp</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">Union</span> (e &#39;<span class="op">:</span> r) m a</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Either</span> (<span class="dt">Union</span> r m a) (e m a)</span></code></pre></div>
<hr />
<p>Surprisingly, this thing works!</p>
</div>
<div class="incremental">
<p>But it’s slow.</p>
</div>
<div class="incremental">
<p>Because <code>runState</code> is recursive, GHC won’t perform any optimizations on it :(</p>
<hr />
<p>We can “break the recursion” by hand.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="ot">runState ::</span> s <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">State</span> s &#39;<span class="op">:</span> r) a <span class="ot">-&gt;</span> <span class="dt">Free</span> r (s, a)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>runState s (<span class="dt">Pure</span> a) <span class="ot">=</span> <span class="fu">pure</span> (s, a)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>runState s (<span class="dt">Impure</span> u) <span class="ot">=</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> decomp u <span class="kw">of</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Left</span> other <span class="ot">-&gt;</span> <span class="dt">Impure</span> <span class="op">$</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>      weave (s, ())</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>            (\(s, m) <span class="ot">-&gt;</span> runState_b s m)</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>            other</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Right</span> (<span class="dt">Get</span> k)    <span class="ot">-&gt;</span> <span class="fu">pure</span> (s,  k s)</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Right</span> (<span class="dt">Put</span> s k) <span class="ot">-&gt;</span> <span class="fu">pure</span> (s, k)</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# INLINE runState #-}</span></span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb82"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="ot">runState_b ::</span> s <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">State</span> s &#39;<span class="op">:</span> r) a <span class="ot">-&gt;</span> <span class="dt">Free</span> r (s, a)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>runState_b <span class="ot">=</span> runState</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# NOINLINE runState_b #-}</span></span></code></pre></div>
</div>
<div class="incremental">
<p>Now GHC is happy and will make our program <strong>fast</strong>!</p>
<hr />
<p>Lots of the boilerplate in <code>fused-effects</code> comes from needing to write <code>Effect</code> instances.</p>
</div>
<div class="incremental">
<p>But these instances are necessary for higher-order effects!</p>
</div>
<div class="incremental">
<p>Are we cursed to always have this boilerplate?</p>
<hr />
<p>No!</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb83"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Yo</span> e m a <span class="kw">where</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Yo</span><span class="ot"> ::</span> <span class="dt">Functor</span> tk</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>     <span class="ot">=&gt;</span> e m a</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>     <span class="ot">-&gt;</span> tk ()</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>     <span class="ot">-&gt;</span> (<span class="kw">forall</span> x<span class="op">.</span> tk (m x) <span class="ot">-&gt;</span> n (tk x))</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>     <span class="ot">-&gt;</span> (tk a <span class="ot">-&gt;</span> b)</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>     <span class="ot">-&gt;</span> <span class="dt">Yo</span> e n b</span></code></pre></div>
<p><code>Yo</code> is the free <code>Effect</code>!</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb84"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Effect</span> (<span class="dt">Yo</span> e) <span class="kw">where</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  weave tk&#39; distrib&#39; (<span class="dt">Yo</span> e tk distrib f) <span class="ot">=</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Yo</span> e (<span class="dt">Compose</span> <span class="op">$</span> tk <span class="op">&lt;$</span> tk&#39;)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>         (<span class="fu">fmap</span> <span class="dt">Compose</span> <span class="op">.</span> distrib&#39; <span class="op">.</span> <span class="fu">fmap</span> distrib <span class="op">.</span> getCompose)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>         (<span class="fu">fmap</span> f <span class="op">.</span> getCompose)</span></code></pre></div>
<hr />
<p>And we can get into a <code>Yo</code> by using an <code>Identity</code> functor as our initial state.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="ot">liftYo ::</span> <span class="dt">Functor</span> m <span class="ot">=&gt;</span> e m a <span class="ot">-&gt;</span> <span class="dt">Yo</span> e m a</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>liftYo e <span class="ot">=</span> <span class="dt">Yo</span> e (<span class="dt">Identity</span> ())</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>                (<span class="fu">fmap</span> <span class="dt">Identity</span> <span class="op">.</span> runIdentity)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>                runIdentity</span></code></pre></div>
<hr />
<p>Somewhat amazingly, this works!</p>
</div>
<div class="incremental">
<p>But all it means is we’ve delayed giving a meaning for <code>Effect</code> until we need to interpret it.</p>
<hr />
<p>A problem:</p>
<p>The type of <code>runFree</code> doesn’t allow us to change the return type.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>runFree</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> ∀ m<span class="op">.</span> <span class="dt">Monad</span> m</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> <span class="dt">Free</span> r a</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> (∀ x<span class="op">.</span> <span class="dt">Union</span> r (<span class="dt">Free</span> r) x <span class="ot">-&gt;</span> m x)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> m a</span></code></pre></div>
</div>
<div class="incremental">
<p>It seems like maybe we could just stick a functor in here.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb87"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>runFree</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> ∀ m tk<span class="op">.</span> (<span class="dt">Monad</span> m, <span class="dt">Functor</span> tk)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> <span class="dt">Free</span> r a</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> (∀ x<span class="op">.</span> <span class="dt">Union</span> r (<span class="dt">Freer</span> r) x <span class="ot">-&gt;</span> m (tk x))</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> m (tk a)</span></code></pre></div>
</div>
<div class="incremental">
<p><strong>Unfortunately this is no longer a <code>Monad</code>!</strong></p>
<hr />
<p>Recall that we’re allowed to pick <em>any</em> <code>Monad</code> for the result of <code>runFree</code>.</p>
<p>Instead of evaluating to the final monad <code>m</code>…</p>
<hr />
<p>Just transform it into <code>StateT s m</code> and immediately evaluate <em>that</em>!</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb88"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Control.Monad.Trans.State</span> <span class="kw">as</span> <span class="dt">S</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>runState</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> s</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Free</span> (e &#39;<span class="op">:</span> r) a</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Free</span> r (s, a)</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>runState s (<span class="dt">Free</span> m) <span class="ot">=</span> <span class="dt">Free</span> <span class="op">$</span> \nt <span class="ot">-&gt;</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>  S.runStateT s <span class="op">$</span> m <span class="op">$</span> \u <span class="ot">-&gt;</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> decomp u <span class="kw">of</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Left</span> x <span class="ot">-&gt;</span> <span class="dt">S.StateT</span> <span class="op">$</span> \s&#39; <span class="ot">-&gt;</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>        nt <span class="op">.</span> weave (s&#39;, ()) (<span class="fu">uncurry</span> <span class="op">$</span> runState f)</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>           <span class="op">$</span> x</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Right</span> (<span class="dt">Yo</span> <span class="dt">Get</span> _ f)      <span class="ot">-&gt;</span> <span class="fu">fmap</span> f <span class="op">$</span> S.get</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Right</span> (<span class="dt">Yo</span> (<span class="dt">Put</span> s&#39;) _ f) <span class="ot">-&gt;</span> <span class="fu">fmap</span> f <span class="op">$</span> S.put s&#39;</span></code></pre></div>
<hr />
<p>We’ve solved all of the problems! We now have solutions for</p>
<ul>
<li><em>performance</em></li>
<li><em>expressiveness</em></li>
<li><em>boilerplate</em></li>
</ul>
<p>all of which work together!</p>
</div>
<div class="incremental">
<p>But what we’ve built isn’t yet a joyful experience.</p>
</div>
<div class="incremental">
<p>In particular, dealing with <code>Yo</code> is painful.</p>
<hr />
<p>We can clean up the mess of writing effect handlers…</p>
</div>
<div class="incremental">
<p>…</p>
</div>
<div class="incremental">
<p>…with an effect-handler effect!</p>
<hr />
<p>Instead of this:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Effect</span> (<span class="dt">Error</span> e) <span class="kw">where</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  weave _ _ (<span class="dt">Throw</span> e) <span class="ot">=</span> <span class="dt">Throw</span> e</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  weave tk distrib (<span class="dt">Catch</span> try handle k) <span class="ot">=</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Catch</span> (distrib <span class="op">$</span> try <span class="op">&lt;$</span> tk)</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>          (\e <span class="ot">-&gt;</span> distrib <span class="op">$</span> handle e <span class="op">&lt;$</span> tk)</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>          (<span class="fu">fmap</span> k)</span></code></pre></div>
<hr />
<p>We can just write this:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>runError <span class="ot">=</span> interpretH <span class="op">$</span> \<span class="kw">case</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Catch</span> try handle <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    t <span class="ot">&lt;-</span> runT try</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    tried <span class="ot">&lt;-</span> runError t</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> tried <span class="kw">of</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Right</span> a <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> a</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Left</span> e <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>        h <span class="ot">&lt;-</span> bindT handle</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>        handled <span class="ot">&lt;-</span> h e</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> handled <span class="kw">of</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Right</span> a <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> a</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Left</span> e2 <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> e2</span></code></pre></div>
<p>The magic is in <code>runT</code> and <code>bindT</code>.</p>
<hr />
<p>These combinators come from the <code>Tactics</code> effect:</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb91"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Tactics</span> tk n r m a <span class="kw">where</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">GetInitialState</span><span class="ot">     ::</span> <span class="dt">Tactics</span> tk n r m (tk ())</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">HoistInterpretation</span><span class="ot"> ::</span> (a <span class="ot">-&gt;</span> n b)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>                      <span class="ot">-&gt;</span> <span class="dt">Tactics</span> tk n r m (tk a <span class="ot">-&gt;</span> <span class="dt">Free</span> r (tk b))</span></code></pre></div>
</div>
<div class="incremental">
<ul>
<li><code>GetInitialState</code> is the <code>tk ()</code> parameter</li>
</ul>
</div>
<div class="incremental">
<ul>
<li><code>HoistInterpretation</code> is the distribution law</li>
</ul>
<hr />
<div class="sourceCode" id="cb92"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">WithTactics</span> e tk m r <span class="ot">=</span> <span class="dt">Tactics</span> tk m (e &#39;<span class="op">:</span> r) &#39;<span class="op">:</span> r</span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb93"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>pureT</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="ot">   ::</span> a</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>   <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">WithTactics</span> e tk m r) (tk a)</span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb94"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>runT</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> m a</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">WithTactics</span> e tk m r)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>                (<span class="dt">Free</span> (e &#39;<span class="op">:</span> r) (tk a))</span></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb95"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>bindT</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> (a <span class="ot">-&gt;</span> m b)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">WithTactics</span> e tk m r)</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>                (tk a <span class="ot">-&gt;</span> <span class="dt">Free</span> (e &#39;<span class="op">:</span> r) (tk b))</span></code></pre></div>
<hr />
<p>This is where we stop.</p>
</div>
<div class="incremental">
<p>We’ve now simultaneously solved the boilerplate and performance problems, as well as put a friendly UX around the whole thing.</p>
<hr />
<p>I’d like to leave you with a comparison.</p>
</div>
<div class="incremental">
<p>First, the implementation of <code>bracket</code> in <code>fused-effects</code>:</p>
<hr />
<div class="sourceCode" id="cb96"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Resource</span> m k</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="kw">forall</span> resource <span class="fu">any</span> output<span class="op">.</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Resource</span> (m resource)</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>               (resource <span class="ot">-&gt;</span> m <span class="fu">any</span>)</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>               (resource <span class="ot">-&gt;</span> m output)</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>               (output <span class="ot">-&gt;</span> k)</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="kw">deriving</span> <span class="kw">instance</span> <span class="dt">Functor</span> (<span class="dt">Resource</span> m)</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HFunctor</span> <span class="dt">Resource</span> <span class="kw">where</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>  hmap f (<span class="dt">Resource</span> acquire release use k) <span class="ot">=</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Resource</span> (f acquire) (f <span class="op">.</span> release) (f <span class="op">.</span> use) k</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Effect</span> <span class="dt">Resource</span> <span class="kw">where</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>  handle state handler (<span class="dt">Resource</span> acquire release use k)</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=</span> <span class="dt">Resource</span> (handler (acquire <span class="op">&lt;$</span> state))</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>               (handler <span class="op">.</span> <span class="fu">fmap</span> release)</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>               (handler <span class="op">.</span> <span class="fu">fmap</span> use)</span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>               (handler <span class="op">.</span> <span class="fu">fmap</span> k)</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a><span class="ot">bracket ::</span> (<span class="dt">Member</span> <span class="dt">Resource</span> sig, <span class="dt">Carrier</span> sig m)</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=&gt;</span> m resource</span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>        <span class="ot">-&gt;</span> (resource <span class="ot">-&gt;</span> m <span class="fu">any</span>)</span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>        <span class="ot">-&gt;</span> (resource <span class="ot">-&gt;</span> m a)</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>        <span class="ot">-&gt;</span> m a</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>bracket acquire release use <span class="ot">=</span></span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>  send (<span class="dt">Resource</span> acquire release use <span class="fu">pure</span>)</span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a><span class="ot">runResource ::</span> (<span class="kw">forall</span> x <span class="op">.</span> m x <span class="ot">-&gt;</span> <span class="dt">IO</span> x)</span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a>            <span class="ot">-&gt;</span> <span class="dt">ResourceC</span> m a</span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>            <span class="ot">-&gt;</span> m a</span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>runResource handler <span class="ot">=</span> runReader (<span class="dt">Handler</span> handler) <span class="op">.</span> runResourceC</span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">ResourceC</span> m a <span class="ot">=</span> <span class="dt">ResourceC</span></span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> runResourceC ::</span> <span class="dt">ReaderC</span> (<span class="dt">Handler</span> m) m a</span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> ( <span class="dt">Alternative</span>, <span class="dt">Applicative</span>, <span class="dt">Functor</span>, <span class="dt">Monad</span>, <span class="dt">MonadFail</span>, <span class="dt">MonadIO</span>, <span class="dt">MonadPlus</span>)</span>
<span id="cb96-39"><a href="#cb96-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-40"><a href="#cb96-40" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">MonadTrans</span> <span class="dt">ResourceC</span> <span class="kw">where</span></span>
<span id="cb96-41"><a href="#cb96-41" aria-hidden="true" tabindex="-1"></a>  lift <span class="ot">=</span> <span class="dt">ResourceC</span> <span class="op">.</span> lift</span>
<span id="cb96-42"><a href="#cb96-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-43"><a href="#cb96-43" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Handler</span> m <span class="ot">=</span> <span class="dt">Handler</span> (<span class="kw">forall</span> x <span class="op">.</span> m x <span class="ot">-&gt;</span> <span class="dt">IO</span> x)</span>
<span id="cb96-44"><a href="#cb96-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-45"><a href="#cb96-45" aria-hidden="true" tabindex="-1"></a><span class="ot">runHandler ::</span> <span class="dt">Handler</span> m <span class="ot">-&gt;</span> <span class="dt">ResourceC</span> m a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</span>
<span id="cb96-46"><a href="#cb96-46" aria-hidden="true" tabindex="-1"></a>runHandler h<span class="op">@</span>(<span class="dt">Handler</span> handler) <span class="ot">=</span> handler <span class="op">.</span> runReader h <span class="op">.</span> runResourceC</span>
<span id="cb96-47"><a href="#cb96-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-48"><a href="#cb96-48" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Carrier</span> sig m, <span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span></span>
<span id="cb96-49"><a href="#cb96-49" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Carrier</span> (<span class="dt">Resource</span> <span class="op">:+:</span> sig) (<span class="dt">ResourceC</span> m) <span class="kw">where</span></span>
<span id="cb96-50"><a href="#cb96-50" aria-hidden="true" tabindex="-1"></a>  eff (<span class="dt">L</span> (<span class="dt">Resource</span> acquire release use k)) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb96-51"><a href="#cb96-51" aria-hidden="true" tabindex="-1"></a>    handler <span class="ot">&lt;-</span> <span class="dt">ResourceC</span> ask</span>
<span id="cb96-52"><a href="#cb96-52" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> liftIO (Exc.bracket</span>
<span id="cb96-53"><a href="#cb96-53" aria-hidden="true" tabindex="-1"></a>      (runHandler handler acquire)</span>
<span id="cb96-54"><a href="#cb96-54" aria-hidden="true" tabindex="-1"></a>      (runHandler handler <span class="op">.</span> release)</span>
<span id="cb96-55"><a href="#cb96-55" aria-hidden="true" tabindex="-1"></a>      (runHandler handler <span class="op">.</span> use))</span>
<span id="cb96-56"><a href="#cb96-56" aria-hidden="true" tabindex="-1"></a>    k a</span>
<span id="cb96-57"><a href="#cb96-57" aria-hidden="true" tabindex="-1"></a>  eff (<span class="dt">R</span> other) <span class="ot">=</span> <span class="dt">ResourceC</span> (eff (<span class="dt">R</span> (handleCoercible other)))</span></code></pre></div>
<hr />
<p>Compare to <code>polysemy</code>:</p>
<hr />
<div class="sourceCode" id="cb97"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Resource</span> m a <span class="kw">where</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Bracket</span><span class="ot"> ::</span> m a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m ()) <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m b) <span class="ot">-&gt;</span> <span class="dt">Resource</span> m b</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>makeSemantic &#39;<span class="dt">&#39;Resource</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>runResource</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">Member</span> (<span class="dt">Lift</span> <span class="dt">IO</span>) r</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=&gt;</span> (∀ x<span class="op">.</span> <span class="dt">Semantic</span> r x <span class="ot">-&gt;</span> <span class="dt">IO</span> x)</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Semantic</span> (<span class="dt">Resource</span> &#39;<span class="op">:</span> r) a</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Semantic</span> r a</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>runResource finish <span class="ot">=</span> interpretH <span class="op">$</span> \<span class="kw">case</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Bracket</span> alloc dealloc use <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> runT  alloc</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> bindT dealloc</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> bindT use</span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> runIt <span class="ot">=</span> finish <span class="op">.@</span> runResource</span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>    sendM <span class="op">$</span> X.bracket (runIt a) (runIt <span class="op">.</span> d) (runIt <span class="op">.</span> u)</span></code></pre></div>
<hr />
</div>
<h2 id="shoutouts"><a href="#shoutouts" class="header-link">Shoutouts<span class="header-link-emoji">🔗</span></a></h2>
<blockquote>
<p>My girlfriend Virginie for putting up with me talking about free monads for two months.</p>
</blockquote>
<div class="incremental">
<blockquote>
<p>Li-Yao Xia for showing me the final encoding of <code>Freer</code>.</p>
</blockquote>
</div>
<div class="incremental">
<blockquote>
<p>Rob Rix for sitting down with me and explaining how the heck <code>fused-effects</code> is so fast.</p>
</blockquote>
<hr />
</div>
</div>
<h1 id="thanks-for-listening"><a href="#thanks-for-listening" class="header-link">Thanks for listening!<span class="header-link-emoji">🔗</span></a></h1>
<div class="incremental">
<p>Questions?</p>
</div>

<p class="meta">
</p>

</div>

<div class="comments">
  <script src="https://utteranc.es/client.js" repo="isovector/reasonablypolymorphic.com" issue-term="pathname" theme="github-light" crossorigin="anonymous" async>
  </script>
</div>
</article>

</div>
    <nav>
        <h1><a href="/">REASONABLY<br />POLYMORPHIC</a></h1>
    
        <p> Hi there. I&#39;m <strong>Sandy Maguire</strong>. I like improving life and
        making cool things.</p>
    
        <p>If you want to get in touch, I&#39;d love to hear from you! Send me an
        email; you can contact me via <tt><b>sandy</b></tt> at <tt><b>sandymaguire.me</b></tt>.</p>
    
        <h2>SITE LINKS</h2>
        <ul>
            <li><a href="/">Archives</a></li>
            <li><a href="/talks">Talks</a></li>
        </ul>
    
        <h2>THINGS I MAKE</h2>
        <ul>
            <li>Code on <a href="http://github.com/isovector">github</a></li>
            <li>Book <a href="/book/preface.html">archive</a></li>
            <li>My other <a href="http://sandymaguire.me">blog</a></li>
        </ul>
    
        <h2>WHAT I&#39;M DOING</h2>
        <ul>
            <!-- <li><a href="/erdos">Erdos Project</a></li> -->
            <li>Music at <a href="http://last.fm/user/Paamayim">last.fm</a></li>
            <li>Books at <a href="https://www.goodreads.com/review/list/14945161-sandy-maguire?shelf=currently-reading">goodreads</a></li>
            <!-- <li>Papers at <a href="https://www.mendeley.com/groups/7295141/read/papers/">mendeley</a></li> -->
        </ul>
    
        <p>
        © 2015-2023 Sandy Maguire
        </p>
    </nav>

    <!--
    <div id="smallnav">
      <div class="smallhome"><a href="/">REASONABLY POLYMORPHIC</a></div>
      <div class="smallarchives"><a href="/blog/archives/">ARCHIVES</a></div>
    </div>
    -->
</body>
</html>

